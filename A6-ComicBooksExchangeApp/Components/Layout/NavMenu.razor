@using Blazored.LocalStorage
@using A6_ComicBooksExchangeApp.Services
@inject ILocalStorageService LocalStorage
@inject AuthStateProvider AuthState
@inject HttpClient Http
@implements IDisposable

<MudNavMenu>
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>

    <!-- Authentication Links -->
    @if (isAuthenticated)
    {
        <MudDivider Class="my-2" />
        <MudText Typo="Typo.caption" Class="px-4 py-2">
            Welcome, <strong>@currentUsername</strong>
        </MudText>
        <MudNavLink Href="profile" Icon="@Icons.Material.Filled.Person">My Profile</MudNavLink>
        <MudNavLink Href="messages" Icon="@Icons.Material.Filled.Mail">
            Messages
            @if (unreadCount > 0)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="ml-2">@unreadCount</MudChip>
            }
        </MudNavLink>
        <MudNavLink Href="logout" Icon="@Icons.Material.Filled.Logout">Logout</MudNavLink>
        <MudDivider Class="my-2" />
    }
    else
    {
        <MudDivider Class="my-2" />
        <MudNavLink Href="login" Icon="@Icons.Material.Filled.Login">Login</MudNavLink>
        <MudNavLink Href="register" Icon="@Icons.Material.Filled.PersonAdd">Register</MudNavLink>
        <MudDivider Class="my-2" />
    }

    <MudNavGroup Title="Comics" Icon="@Icons.Material.Filled.MenuBook" Expanded="false">
        <MudNavLink Href="comics" Icon="@Icons.Material.Filled.Search">Browse Comics</MudNavLink>
        <MudNavLink Href="list-comic" Icon="@Icons.Material.Filled.Add">Add Comic</MudNavLink>
        <MudNavLink Href="my-collection" Icon="@Icons.Material.Filled.LibraryBooks">My Library</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Loans" Icon="@Icons.Material.Filled.Handshake" Expanded="false">
        <MudNavLink Href="loans" Icon="@Icons.Material.Filled.SwapHoriz">My Loans</MudNavLink>
        <MudNavLink Href="loan-history" Icon="@Icons.Material.Filled.History">Loan History</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Community" Icon="@Icons.Material.Filled.Groups" Expanded="false">
        <MudNavLink Href="community" Icon="@Icons.Material.Filled.People">Find Members</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Resources" Icon="@Icons.Material.Filled.Info" Expanded="false">
        <MudNavLink Href="about" Icon="@Icons.Material.Filled.HelpCenter">About Us</MudNavLink>
        <MudNavLink Href="guide" Icon="@Icons.Material.Filled.MenuBook">How It Works</MudNavLink>
        <MudNavLink Href="faq" Icon="@Icons.Material.Filled.QuestionAnswer">FAQ</MudNavLink>
    </MudNavGroup>

</MudNavMenu>

@code {
    private bool isAuthenticated = false;
    private string currentUsername = "";
    private int currentUserId = 0;
    private int unreadCount = 0;
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to auth state changes
        AuthState.OnAuthStateChanged += OnAuthStateChanged;

        // Check if user is authenticated by reading from localStorage
        await LoadAuthState();
        
        // Start polling for unread messages if authenticated
        if (isAuthenticated)
        {
            await LoadUnreadCount();
            StartUnreadCountPolling();
        }
    }

    private async Task LoadAuthState()
    {
        try
        {
            var authState = await LocalStorage.GetItemAsync<bool>("isAuthenticated");
            if (authState)
            {
                isAuthenticated = true;
                var username = await LocalStorage.GetItemAsync<string>("currentUsername");
                currentUsername = username ?? "User";
                currentUserId = await LocalStorage.GetItemAsync<int>("currentUserId");

                // Sync with AuthStateProvider
                AuthState.SetInitialState(true, currentUserId, currentUsername);
            }
            else
            {
                isAuthenticated = false;
                AuthState.SetInitialState(false);
            }
        }
        catch
        {
            isAuthenticated = false;
            AuthState.SetInitialState(false);
        }
    }

    private void OnAuthStateChanged()
    {
        isAuthenticated = AuthState.IsAuthenticated;
        currentUsername = AuthState.CurrentUsername;
        currentUserId = AuthState.CurrentUserId;
        
        if (isAuthenticated && currentUserId > 0)
        {
            _ = LoadUnreadCount();
            StartUnreadCountPolling();
        }
        else
        {
            StopUnreadCountPolling();
            unreadCount = 0;
        }
        
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadUnreadCount()
    {
        if (currentUserId <= 0) return;
        
        try
        {
            var response = await Http.GetFromJsonAsync<UnreadCountResponse>($"api/messages/unread/count/{currentUserId}");
            unreadCount = response?.Count ?? 0;
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // Silently fail - not critical
        }
    }

    private void StartUnreadCountPolling()
    {
        // Poll every 30 seconds
        _timer = new System.Threading.Timer(async _ =>
        {
            await LoadUnreadCount();
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void StopUnreadCountPolling()
    {
        _timer?.Dispose();
        _timer = null;
    }

    public void Dispose()
    {
        AuthState.OnAuthStateChanged -= OnAuthStateChanged;
        StopUnreadCountPolling();
    }

    private class UnreadCountResponse
    {
        public int Count { get; set; }
    }
}