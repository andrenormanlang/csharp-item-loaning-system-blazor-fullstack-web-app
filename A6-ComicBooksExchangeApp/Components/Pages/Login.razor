@page "/login"
@using MudBlazor
@using A6_ComicBooksExchangeApp.Services
@using Blazored.LocalStorage
@inject AuthService AuthService
@inject AuthStateProvider AuthState
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject ILogger<Login> Logger

<PageTitle>Login - Comic Exchange</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-6">
                <MudText Typo="Typo.h4" GutterBottom="true" Align="Align.Center">
                    Welcome Back!
                </MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6">
                    Sign in to your Comic Exchange account
                </MudText>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">@successMessage</MudAlert>
                }

                <MudForm @ref="form" @bind-IsValid="isFormValid">
                    <MudTextField @bind-Value="email" Label="Email" Variant="Variant.Outlined" FullWidth Required="true"
                        RequiredError="Email is required"
                        Validation="@(new Func<string, IEnumerable<string>>(ValidateEmail))" Class="mb-4">
                    </MudTextField>

                    <MudTextField @bind-Value="password" Label="Password" Variant="Variant.Outlined" FullWidth
                        InputType="InputType.Password" Required="true" RequiredError="Password is required"
                        Class="mb-6">
                    </MudTextField>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth Size="Size.Large"
                        OnClick="Submit" Disabled="isLoading || !isFormValid" Class="mb-4">
                        @if (isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Signing In...</MudText>
                        }
                        else
                        {
                            <MudText>Sign In</MudText>
                        }
                    </MudButton>
                </MudForm>

                <MudDivider Class="my-4" />

                <MudText Align="Align.Center" Class="mb-4">
                    Don't have an account?
                    <MudLink Href="/register">Sign up here</MudLink>
                </MudText>

                <MudText Typo="Typo.caption" Align="Align.Center" Class="text-muted">
                    Secure login with password hashing
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private MudForm? form;
    private string email = string.Empty;
    private string password = string.Empty;
    private bool isLoading = false;
    private bool isFormValid = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private IEnumerable<string> ValidateEmail(string value)
    {
        if (string.IsNullOrEmpty(value))
            yield break;

        if (!value.Contains("@") || !value.Contains("."))
            yield return "Invalid email address";
    }

    private async Task Submit()
    {
        if (form is null) return;
        
        await form.Validate();
        if (!form.IsValid)
            return;

        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var (success, user, message) = await AuthService.LoginAsync(email, password);

            if (success && user != null)
            {
                successMessage = "Login successful! Redirecting...";
                Logger.LogInformation($"User logged in: {user.Username}");

                // Save user data to localStorage
                await LocalStorage.SetItemAsync("currentUserId", user.Id);
                await LocalStorage.SetItemAsync("currentUsername", user.Username);
                await LocalStorage.SetItemAsync("currentEmail", user.Email);
                await LocalStorage.SetItemAsync("currentFullName", user.FullName);
                await LocalStorage.SetItemAsync("isAuthenticated", true);

                // Notify AuthStateProvider to update UI components
                AuthState.NotifyLogin(user.Id, user.Username);

                // Wait briefly to show success message
                await Task.Delay(1500);

                // Redirect to home or dashboard
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = message;
                Logger.LogWarning($"Login failed: {message}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during login");
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}