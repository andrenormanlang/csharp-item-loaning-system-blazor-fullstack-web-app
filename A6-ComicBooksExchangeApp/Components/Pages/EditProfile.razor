@page "/edit-profile"
@using MudBlazor
@using Blazored.LocalStorage
@using System.Net.Http.Json
@using A6_ComicBooksExchangeApp.Services
@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject ILogger<EditProfile> Logger
@inject AuthStateProvider AuthState

<PageTitle>Edit Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-8">
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h4" GutterBottom="true">Edit Your Profile</MudText>
                <MudText Typo="Typo.body2" Class="mb-6">Update your profile information below.</MudText>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">@successMessage</MudAlert>
                }

                @if (isLoading)
                {
                    <MudProgressLinear Indeterminate="true" Class="mb-4" />
                    <MudText Align="Align.Center">Loading profile...</MudText>
                }
                else if (profile == null)
                {
                    <MudAlert Severity="Severity.Warning">Could not load profile. Please try again.</MudAlert>
                }
                else
                {
                    <MudForm @ref="form">
                        <MudGrid>
                            <!-- Profile Image Section -->
                            <MudItem xs="12">
                                <MudPaper Elevation="1" Class="pa-4 mb-4">
                                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Profile Image</strong>
                                    </MudText>
                                    <MudGrid>
                                        <MudItem xs="12" sm="8">
                                            <MudTextField @bind-Value="profile.ImageUrl" Label="Profile Image URL"
                                                Variant="Variant.Outlined"
                                                HelperText="Enter a URL to an image (e.g., from Gravatar, imgur, etc.)"
                                                Placeholder="https://example.com/your-image.jpg" />
                                        </MudItem>
                                        <MudItem xs="12" sm="4" Class="d-flex justify-center align-center">
                                            @if (!string.IsNullOrWhiteSpace(profile.ImageUrl))
                                            {
                                                <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px;">
                                                    <MudImage Src="@profile.ImageUrl" Alt="Profile Preview"
                                                        ObjectFit="ObjectFit.Cover" />
                                                </MudAvatar>
                                            }
                                            else
                                            {
                                                <MudAvatar Size="Size.Large" Style="width: 100px; height: 100px;"
                                                    Color="Color.Secondary">
                                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                                                </MudAvatar>
                                            }
                                        </MudItem>
                                    </MudGrid>
                                    <MudText Typo="Typo.caption" Class="mt-2">
                                        Tip: Use a square image for best results. Recommended size: 150x150px or larger.
                                    </MudText>
                                </MudPaper>
                            </MudItem>

                            <MudItem xs="12">
                                <MudDivider />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.FullName" Label="Full Name" Variant="Variant.Outlined"
                                    Required="true" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.Username" Label="Username" Variant="Variant.Outlined"
                                    Required="true" Disabled="true" HelperText="Username cannot be changed" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.Email" Label="Email" Variant="Variant.Outlined"
                                    Required="true" InputType="InputType.Email" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.PhoneNumber" Label="Phone Number (Optional)"
                                    Variant="Variant.Outlined" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.Location" Label="Location" Variant="Variant.Outlined"
                                    Placeholder="e.g., New York, NY" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="profile.PreferredExchangeMethod" Label="Preferred Shipping Method"
                                    Variant="Variant.Outlined">
                                    <MudSelectItem Value="@("Mail")">Mail</MudSelectItem>
                                    <MudSelectItem Value="@("Local Pickup")">Local Pickup</MudSelectItem>
                                    <MudSelectItem Value="@("Both")">Both</MudSelectItem>
                                </MudSelect>
                            </MudItem>

                            <MudItem xs="12">
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Reading Preferences</strong>
                                </MudText>
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.CollectingFocus" Label="Reading Interests"
                                    Variant="Variant.Outlined" Required="true"
                                    Placeholder="e.g., Silver Age Marvel, DC Comics" />
                            </MudItem>

                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="profile.PreferredEras" Label="Preferred Eras"
                                    Variant="Variant.Outlined" Placeholder="e.g., Silver Age, Bronze Age" />
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField @bind-Value="profile.FavoriteCharacters" Label="Favorite Characters"
                                    Variant="Variant.Outlined" Placeholder="e.g., Spider-Man, Batman, X-Men" />
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField @bind-Value="profile.Biography" Label="About Me" Variant="Variant.Outlined"
                                    Multiline="true" Lines="3"
                                    Placeholder="Tell other members about yourself and your comic interests..." />
                            </MudItem>

                            <MudItem xs="12">
                                <MudTextField @bind-Value="profile.TradePreferences" Label="Lending Preferences"
                                    Variant="Variant.Outlined" Multiline="true" Lines="2"
                                    Placeholder="e.g., Prefer verified members, handle with care..." />
                            </MudItem>

                            <MudItem xs="12" Class="d-flex gap-2 mt-4">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveProfile"
                                    Disabled="isSaving">
                                    @if (isSaving)
                                    {
                                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                        <MudText Class="ms-2">Saving...</MudText>
                                    }
                                    else
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                                        <MudText>Save Changes</MudText>
                                    }
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel"
                                    Disabled="isSaving">Cancel</MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudForm>

                    <MudDivider Class="my-6" />

                    <!-- Delete Account Section -->
                    <MudExpansionPanels>
                        <MudExpansionPanel Text="Danger Zone" Icon="@Icons.Material.Filled.Warning"
                            Style="background-color: #ffebee;">
                            <MudText Typo="Typo.body2" Class="mb-4">
                                <strong>Delete your account permanently.</strong> This action cannot be undone.
                                All your comics, reviews, and data will be removed.
                            </MudText>

                            @if (hasActiveLoans)
                            {
                                <MudAlert Severity="Severity.Warning" Class="mb-4">
                                    <strong>Cannot delete account:</strong> You have active loans.
                                    Please return all borrowed comics and wait for your lent comics to be returned before
                                    deleting your account.
                                </MudAlert>
                            }

                            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="OpenDeleteDialog"
                                Disabled="hasActiveLoans || isDeleting">
                                @if (isDeleting)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Deleting...</MudText>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.DeleteForever" Class="mr-1" />
                                    <MudText>Delete My Account</MudText>
                                }
                            </MudButton>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<!-- Delete Confirmation Dialog -->
<MudDialog @bind-Visible="showDeleteDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" Class="mr-2" />
            Confirm Account Deletion
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-4">
            Are you absolutely sure you want to delete your account?
        </MudText>
        <MudText Typo="Typo.body2">
            This will permanently delete:
        </MudText>
        <MudList T="string" Dense="true">
            <MudListItem Icon="@Icons.Material.Filled.Person">Your profile and all personal data</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.LibraryBooks">All comics in your library</MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.RateReview">All reviews you've received</MudListItem>
        </MudList>
        <MudTextField @bind-Value="deleteConfirmation" Label="Type DELETE to confirm" Variant="Variant.Outlined"
            Class="mt-4" FullWidth="true" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDeleteDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="DeleteAccount"
            Disabled="@(deleteConfirmation != "DELETE")">
            Delete Forever
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudForm form = null!;
    private UserProfileEdit? profile;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isDeleting = false;
    private bool hasActiveLoans = false;
    private bool showDeleteDialog = false;
    private string deleteConfirmation = string.Empty;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private int currentUserId = 0;

    private class UserProfileEdit
    {
        public int Id { get; set; }
        public string Username { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string? ImageUrl { get; set; }
        public string CollectingFocus { get; set; } = string.Empty;
        public string PreferredEras { get; set; } = string.Empty;
        public string FavoriteCharacters { get; set; } = string.Empty;
        public string? Biography { get; set; }
        public string? Location { get; set; }
        public string? TradePreferences { get; set; }
        public string PreferredExchangeMethod { get; set; } = "Mail";
        public string PasswordHash { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUserId = await LocalStorage.GetItemAsync<int>("currentUserId");
            if (currentUserId <= 0)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await LoadProfile();
            await CheckActiveLoans();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing edit profile");
            errorMessage = "Failed to load profile. Please try again.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadProfile()
    {
        try
        {
            var response = await Http.GetAsync($"api/users/{currentUserId}");
            if (response.IsSuccessStatusCode)
            {
                profile = await response.Content.ReadFromJsonAsync<UserProfileEdit>();
            }
            else
            {
                Logger.LogWarning($"Failed to load profile: {response.StatusCode}");
                errorMessage = "Failed to load profile.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading profile");
            errorMessage = "Error loading profile.";
        }
    }

    private async Task CheckActiveLoans()
    {
        try
        {
            var response = await Http.GetAsync($"api/users/{currentUserId}/has-active-loans");
            if (response.IsSuccessStatusCode)
            {
                hasActiveLoans = await response.Content.ReadFromJsonAsync<bool>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking active loans");
            // Default to true to prevent accidental deletion
            hasActiveLoans = true;
        }
    }

    private async Task SaveProfile()
    {
        if (profile == null) return;

        await form.Validate();
        if (!form.IsValid) return;

        isSaving = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var response = await Http.PutAsJsonAsync($"api/users/{currentUserId}", profile);

            if (response.IsSuccessStatusCode)
            {
                successMessage = "Profile updated successfully!";

                // Update localStorage with new name if changed
                await LocalStorage.SetItemAsync("currentFullName", profile.FullName);

                // Wait a moment then redirect
                await Task.Delay(1500);
                Navigation.NavigateTo("/profile");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Failed to update profile: {error}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving profile");
            errorMessage = "Error saving profile. Please try again.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/profile");
    }

    private void OpenDeleteDialog()
    {
        deleteConfirmation = string.Empty;
        showDeleteDialog = true;
    }

    private void CloseDeleteDialog()
    {
        showDeleteDialog = false;
        deleteConfirmation = string.Empty;
    }

    private async Task DeleteAccount()
    {
        if (deleteConfirmation != "DELETE") return;

        isDeleting = true;
        showDeleteDialog = false;

        try
        {
            var response = await Http.DeleteAsync($"api/users/{currentUserId}");

            if (response.IsSuccessStatusCode)
            {
                // Clear all local storage
                await LocalStorage.RemoveItemAsync("currentUserId");
                await LocalStorage.RemoveItemAsync("currentUsername");
                await LocalStorage.RemoveItemAsync("currentEmail");
                await LocalStorage.RemoveItemAsync("currentFullName");
                await LocalStorage.RemoveItemAsync("isAuthenticated");

                // Notify auth state
                AuthState.NotifyLogout();

                // Redirect to home with message
                Navigation.NavigateTo("/?deleted=true");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.Message ?? "Cannot delete account due to active loans.";
                hasActiveLoans = true;
            }
            else
            {
                errorMessage = "Failed to delete account. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting account");
            errorMessage = "Error deleting account. Please try again.";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private class ErrorResponse
    {
        public string? Message { get; set; }
    }
}