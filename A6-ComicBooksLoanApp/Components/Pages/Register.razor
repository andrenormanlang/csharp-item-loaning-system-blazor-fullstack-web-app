@page "/register"
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using A6_ComicBooksLoanApp.Services
@using Blazored.LocalStorage
@inject AuthService AuthService
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject ILogger<Register> Logger

<PageTitle>Register - Comic Exchange</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-6">
                <MudText Typo="Typo.h4" GutterBottom="true" Align="Align.Center">
                    Join the Community!
                </MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6">
                    Create your Comic Exchange account
                </MudText>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">@successMessage</MudAlert>
                }

                <MudForm @ref="form" @bind-IsValid="isFormValid">
                    <MudTextField @bind-Value="fullName" Label="Full Name" Variant="Variant.Outlined" FullWidth
                        Required="true" RequiredError="Full name is required" Class="mb-4">
                    </MudTextField>

                    <MudTextField @bind-Value="username" Label="Username" Variant="Variant.Outlined" FullWidth
                        Required="true" RequiredError="Username is required"
                        HelperText="3-20 characters, letters and numbers only"
                        Validation="@(new Func<string, IEnumerable<string>>(ValidateUsername))" Class="mb-4">
                    </MudTextField>

                    <MudTextField @bind-Value="email" Label="Email" Variant="Variant.Outlined" FullWidth Required="true"
                        RequiredError="Email is required"
                        Validation="@(new Func<string, IEnumerable<string>>(ValidateEmail))" Class="mb-4">
                    </MudTextField>

                    <MudTextField @bind-Value="password" Label="Password" Variant="Variant.Outlined" FullWidth
                        InputType="InputType.Password" Required="true" RequiredError="Password is required"
                        HelperText="Minimum 6 characters"
                        Validation="@(new Func<string, IEnumerable<string>>(ValidatePassword))" Class="mb-4">
                    </MudTextField>

                    <MudTextField @bind-Value="confirmPassword" Label="Confirm Password" Variant="Variant.Outlined"
                        FullWidth InputType="InputType.Password" Required="true"
                        RequiredError="Please confirm your password"
                        Validation="@(new Func<string, IEnumerable<string>>(ValidateConfirmPassword))" Class="mb-6">
                    </MudTextField>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth Size="Size.Large"
                        OnClick="Submit" Disabled="isLoading || !isFormValid" Class="mb-4">
                        @if (isLoading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Creating Account...</MudText>
                        }
                        else
                        {
                            <MudText>Create Account</MudText>
                        }
                    </MudButton>
                </MudForm>

                <MudDivider Class="my-4" />

                <MudText Align="Align.Center">
                    Already have an account?
                    <MudLink Href="/login">Sign in here</MudLink>
                </MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudPaper Elevation="1" Class="pa-4" Style="background-color: #f5f5f5;">
                <MudText Typo="Typo.subtitle2" GutterBottom="true">
                    <strong>Why Join?</strong>
                </MudText>
                <MudList T="string" Dense="true">
                    <MudListItem T="string">Build your collector reputation</MudListItem>
                    <MudListItem T="string">Discover rare comics from collectors worldwide</MudListItem>
                    <MudListItem T="string">Make fair trades with verified members</MudListItem>
                    <MudListItem T="string">Connect with other comic enthusiasts</MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private MudForm? form;
    private string fullName = string.Empty;
    private string username = string.Empty;
    private string email = string.Empty;
    private string password = string.Empty;
    private string confirmPassword = string.Empty;
    private bool isLoading = false;
    private bool isFormValid = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private IEnumerable<string> ValidateEmail(string value)
    {
        if (string.IsNullOrEmpty(value))
            yield break;

        if (!value.Contains("@") || !value.Contains("."))
            yield return "Invalid email address";
    }

    private IEnumerable<string> ValidateUsername(string value)
    {
        if (string.IsNullOrEmpty(value))
            yield break;

        if (value.Length < 3 || value.Length > 20)
            yield return "Username must be 3-20 characters";

        if (!System.Text.RegularExpressions.Regex.IsMatch(value, @"^[a-zA-Z0-9_]+$"))
            yield return "Username can only contain letters, numbers, and underscores";
    }

    private IEnumerable<string> ValidatePassword(string value)
    {
        if (string.IsNullOrEmpty(value))
            yield break;

        if (value.Length < 6)
            yield return "Password must be at least 6 characters";
    }

    private IEnumerable<string> ValidateConfirmPassword(string value)
    {
        if (string.IsNullOrEmpty(value))
            yield break;

        if (value != password)
            yield return "Passwords do not match";
    }

    private async Task Submit()
    {
        if (form is null) return;
        
        await form.Validate();
        if (!form.IsValid)
            return;

        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var (success, message) = await AuthService.RegisterAsync(
            email,
            username,
            fullName,
            password);

            if (success)
            {
                successMessage = "Account created successfully! Logging you in...";
                Logger.LogInformation($"User registered: {username}");

                // Auto-login after registration
                await Task.Delay(1000);
                var (loginSuccess, user, loginMessage) = await AuthService.LoginAsync(email, password);

                if (loginSuccess && user != null)
                {
                    // Save user data to localStorage
                    await LocalStorage.SetItemAsync("currentUserId", user.Id);
                    await LocalStorage.SetItemAsync("currentUsername", user.Username);
                    await LocalStorage.SetItemAsync("currentEmail", user.Email);
                    await LocalStorage.SetItemAsync("currentFullName", user.FullName);
                    await LocalStorage.SetItemAsync("isAuthenticated", true);

                    await Task.Delay(500);
                    Navigation.NavigateTo("/");
                }
                else
                {
                    // Registration succeeded but auto-login failed, go to login page
                    Navigation.NavigateTo("/login");
                }
            }
            else
            {
                errorMessage = message;
                Logger.LogWarning($"Registration failed: {message}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during registration");
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}