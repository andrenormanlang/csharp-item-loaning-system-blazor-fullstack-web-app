@page "/comics"
@using MudBlazor
@using Blazored.LocalStorage
@using A6_ComicBooksLoanApp.Services
@using A6_ComicBooksLoanApp.Enums
@inject ComicApiService ComicService
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Browse Comics</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4 py-md-8">
    <MudGrid Spacing="3">

        <MudItem xs="12" sm="12" md="3">
            <MudPaper Elevation="2" Class="pa-3 pa-md-4">

                <MudHidden Breakpoint="Breakpoint.MdAndUp">
                    <MudExpansionPanels Dense="true">
                        <MudExpansionPanel Text="Filters" IsInitiallyExpanded="false">
                            <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">Search by Title</MudText>
                            <MudTextField @bind-Value="searchTerm" Placeholder="Comic title" FullWidth Variant="Variant.Outlined"
                                          Size="Size.Small" OnKeyUp="OnSearchChanged" Immediate="true"></MudTextField>

                            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Era</MudText>
                            <MudSelect T="ComicEra ?"
                                       @bind-Value="selectedEra"
                                       Placeholder="All Eras"
                                       FullWidth
                                       Variant="Variant.Outlined"
                                       Size="Size.Small">
                                <MudSelectItem T="ComicEra ?" Value="null">All Eras</MudSelectItem>
                                @foreach (ComicEra era in Enum.GetValues(typeof(ComicEra)))
                                {
                                    <MudSelectItem T="ComicEra ?" Value="@era">
                                        @era.GetDescription()
                                    </MudSelectItem>
                                }
                            </MudSelect>

                            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Condition</MudText>
                            <MudSelect T="ConditionGrade ?"
                                       @bind-Value="selectedCondition"
                                       Placeholder="All Conditions"
                                       FullWidth
                                       Variant="Variant.Outlined"
                                       Size="Size.Small">
                                <MudSelectItem T="ConditionGrade ?" Value="null">All Conditions</MudSelectItem>
                                @foreach (ConditionGrade item in Enum.GetValues(typeof(ConditionGrade)))
                                {
                                    <MudSelectItem T="ConditionGrade ?" Value="@item">
                                        @item.GetDescription()
                                    </MudSelectItem>
                                }
                            </MudSelect>

                            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Publisher</MudText>
                            <MudSelect T="ComicPublisher ?"
                                       @bind-Value="selectedPublisher"
                                       Placeholder="All Publishers"
                                       FullWidth
                                       Variant="Variant.Outlined"
                                       Size="Size.Small">
                                <MudSelectItem T="ComicPublisher ?" Value="null">All Publishers</MudSelectItem>
                                @foreach (ComicPublisher publisher in Enum.GetValues(typeof(ComicPublisher)))
                                {
                                    <MudSelectItem T="ComicPublisher ?" Value="@publisher">
                                        @publisher.GetDescription()
                                    </MudSelectItem>
                                }
                            </MudSelect>

                            <div Class="mt-4 mb-2">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                                    Apply Filters
                                </MudButton>
                            </div>
                            <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth OnClick="ResetFilters" Class="mt-2" StartIcon="@Icons.Material.Filled.Clear">
                                Reset
                            </MudButton>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudHidden>

                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <MudText Typo="Typo.h6" GutterBottom="true">Filters</MudText>

                    <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2">Search by Title</MudText>
                    <MudTextField @bind-Value="searchTerm" Placeholder="Comic title" FullWidth Variant="Variant.Outlined"
                                  Size="Size.Small" OnKeyUp="OnSearchChanged" Immediate="true"></MudTextField>

                    <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Era</MudText>
                    <MudSelect T="ComicEra ?"
                               @bind-Value="selectedEra"
                               Placeholder="All Eras"
                               FullWidth
                               Variant="Variant.Outlined"
                               Size="Size.Small">
                        <MudSelectItem T="ComicEra ?" Value="null">All Eras</MudSelectItem>
                        @foreach (ComicEra era in Enum.GetValues(typeof(ComicEra)))
                        {
                            <MudSelectItem T="ComicEra ?" Value="@era">
                                @era.GetDescription()
                            </MudSelectItem>
                        }
                    </MudSelect>

                    <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Condition</MudText>
                    <MudSelect T="ConditionGrade ?"
                               @bind-Value="selectedCondition"
                               Placeholder="All Conditions"
                               FullWidth
                               Variant="Variant.Outlined"
                               Size="Size.Small">
                        <MudSelectItem T="ConditionGrade ?" Value="null">All Conditions</MudSelectItem>
                        @foreach (ConditionGrade item in Enum.GetValues(typeof(ConditionGrade)))
                        {
                            <MudSelectItem T="ConditionGrade ?" Value="@item">
                                @item.GetDescription()
                            </MudSelectItem>
                        }
                    </MudSelect>

                    <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Publisher</MudText>
                    <MudSelect T="ComicPublisher ?"
                               @bind-Value="selectedPublisher"
                               Placeholder="All Publishers"
                               FullWidth
                               Variant="Variant.Outlined"
                               Size="Size.Small">
                        <MudSelectItem T="ComicPublisher ?" Value="null">All Publishers</MudSelectItem>
                        @foreach (ComicPublisher publisher in Enum.GetValues(typeof(ComicPublisher)))
                        {
                            <MudSelectItem T="ComicPublisher ?" Value="@publisher">
                                @publisher.GetDescription()
                            </MudSelectItem>
                        }
                    </MudSelect>

                    <div Class="mt-4 mb-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                            Apply Filters
                        </MudButton>
                    </div>
                    <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth OnClick="ResetFilters" Class="mt-2" StartIcon="@Icons.Material.Filled.Clear">
                        Reset
                    </MudButton>
                </MudHidden>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="12" md="9">
            <MudPaper Elevation="2" Class="pa-3 pa-md-4">

                <div class="d-flex flex-column flex-sm-row justify-space-between align-start align-sm-center mb-4 gap-2">
                    <div>
                        <MudText Typo="Typo.h5" GutterBottom="true">Comics Available for Loan</MudText>
                        <MudText Typo="Typo.body2" Class="d-none d-sm-block">
                            Browse comics you can borrow. To borrow a comic, you must offer one of your comics in return.
                        </MudText>
                    </div>
                    @if (totalComics > 0)
                    {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">@totalComics Comics</MudChip>
                    }
                </div>

                @if (isLoading)
                {
                    <MudProgressLinear Indeterminate="true"></MudProgressLinear>
                    <MudText Align="Align.Center" Class="mt-4">Loading comics...</MudText>
                }
                else if (comics == null || comics.Count == 0)
                {
                    <MudAlert Severity="Severity.Info" ContentAlignment="HorizontalAlignment.Start">
                        No comics found matching your filters.
                    </MudAlert>
                }
                else
                {
                    <MudGrid Spacing="3">
                        @foreach (var comic in comics)
                        {
                            <MudItem xs="12" sm="6" md="4" lg="3">
                                <MudCard Class="d-flex flex-column" Style="height: 100%;">
                                    <MudCardMedia Image="@comic.CoverImageUrl" Height="250" Style="object-fit: cover;" />
                                    <MudCardHeader Class="pb-2">
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6" Style="font-size: 1rem; line-height: 1.3;">@comic.Title</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">#@comic.IssueNumber</MudText>
                                        </CardHeaderContent>
                                    </MudCardHeader>

                                    <MudCardContent Class="flex-grow-1 py-2">
                                        <div class="d-flex flex-wrap gap-1 mb-2">
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">
                                                @comic.Era
                                            </MudChip>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Text">
                                                @comic.Publisher
                                            </MudChip>
                                        </div>
                                        <MudText Typo="Typo.body2" Class="mt-2">
                                            <strong>Condition:</strong> @comic.ConditionGrade
                                        </MudText>

                                        <div class="mt-2">
                                            @if (comic.IsOnLoan)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Schedule">
                                                    On Loan
                                                </MudChip>
                                                @if (comic.LoanReturnDate.HasValue)
                                                {
                                                    <MudText Typo="Typo.caption" Class="mt-1">
                                                        Available: @comic.LoanReturnDate.Value.ToShortDateString()
                                                    </MudText>
                                                }
                                            }
                                            else
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled" Icon="@Icons.Material.Filled.CheckCircle">
                                                    Available
                                                </MudChip>
                                            }
                                        </div>
                                    </MudCardContent>

                                    <MudCardActions Class="pa-2">
                                        <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" FullWidth
                                                   OnClick="@(() => ViewComicDetails(comic.Id))">
                                            View Details
                                        </MudButton>
                                        @if (!comic.IsOnLoan)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small" FullWidth
                                                       OnClick="@(() => RequestLoan(comic))">
                                                Request Loan
                                            </MudButton>
                                        }
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>

                    <div class="d-flex justify-center mt-4 mt-md-6">
                        <MudPagination Count="(int)Math.Ceiling(totalComics / (decimal)pageSize)"
                                       Selected="currentPage"
                                       SelectedChanged="OnPageChanged"
                                       Size="Size.Small"
                                       ShowFirstButton="true"
                                       ShowLastButton="true"
                                       BoundaryCount="1"
                                       MiddleCount="3">
                        </MudPagination>
                    </div>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<ComicDto>? comics;
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private ComicEra? selectedEra = null;
    private ConditionGrade? selectedCondition = null;
    private ComicPublisher? selectedPublisher = null;
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalComics = 0;
    private int currentUserId = 0;

    protected override async Task OnInitializedAsync()
    {
        // Get current user ID
        try
        {
            currentUserId = await LocalStorage.GetItemAsync<int>("currentUserId");
        }
        catch
        {
            currentUserId = 0;
        }

        await LoadComics();
    }

    private async Task LoadComics()
    {
        try
        {
            isLoading = true;

            // Convert enums to strings for API calls
            string? eraString = selectedEra.HasValue
                ? selectedEra.Value.GetDescription()
                : null;

            string? conditionString = selectedCondition.HasValue
                ? selectedCondition.Value.GetDescription()
                : null;

            string? publisherString = selectedPublisher.HasValue
                ? selectedPublisher.Value.GetDescription()
                : null;

            var result = await ComicService.SearchComicsPaginatedAsync(
                searchTerm: string.IsNullOrWhiteSpace(searchTerm) ? null : searchTerm,
                era: eraString,
                condition: conditionString,
                publisher: publisherString,
                page: currentPage,
                pageSize: pageSize,
                excludeUserId: currentUserId > 0 ? currentUserId : null
            );

            totalComics = result.TotalCount;
            comics = result.Items;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comics: {ex.Message}");
            Snackbar.Add("Error loading comics. Please try again.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSearchChanged(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await ApplyFilters();
        }
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadComics();
    }

    private async Task ResetFilters()
    {
        searchTerm = string.Empty;
        selectedEra = null;
        selectedCondition = null;
        selectedPublisher = null;
        currentPage = 1;
        await LoadComics();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadComics();
    }

    private void ViewComicDetails(int comicId)
    {
        NavigationManager.NavigateTo($"/comic/{comicId}");
    }

    private async Task RequestLoan(ComicDto comic)
    {
        int currentUserId = 0;
        try
        {
            currentUserId = await LocalStorage.GetItemAsync<int>("currentUserId");
        }
        catch { }

        if (currentUserId <= 0)
        {
            Snackbar.Add("Please log in to request a loan", Severity.Warning);
            NavigationManager.NavigateTo("/login");
            return;
        }

        if (comic.OwnerId == currentUserId)
        {
            Snackbar.Add("You can't borrow your own comic", Severity.Warning);
            return;
        }

        NavigationManager.NavigateTo($"/request-loan/{comic.Id}");
    }
}