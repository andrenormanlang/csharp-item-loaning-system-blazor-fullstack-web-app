@page "/loans"
@using MudBlazor
@using A6_ComicBooksLoanApp.Components.Dialogs
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject ILogger<Loans> Logger
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<PageTitle>My Loans</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h4" GutterBottom="true">My Comic Loans</MudText>
            <MudText Typo="Typo.body2" Class="mb-6">Manage your comic book loans - both comics you've borrowed and
                comics you've lent out.</MudText>
        </MudItem>

        <MudItem xs="12">
            <MudTabs>
                <MudTabPanel Text="Loan Requests">
                    @if (pendingRequests == null || pendingRequests.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-4">
                            No pending loan requests at the moment.
                        </MudAlert>
                    }
                    else
                    {
                        <MudGrid Class="mt-4">
                            @foreach (var request in pendingRequests)
                            {
                                var isIncoming = request.OwnerId == currentUserId;
                                var isOutgoing = request.RequesterId == currentUserId;

                                <MudItem xs="12">
                                    <MudCard>
                                        <MudCardHeader>
                                            <CardHeaderContent>
                                                @if (isOutgoing)
                                                {
                                                    <MudText Typo="Typo.h6">Your Loan Request to @request.OwnerUsername</MudText>
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">Outgoing Request</MudChip>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.h6">Loan Request from @request.RequesterUsername</MudText>
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">Incoming Request</MudChip>
                                                }
                                                <MudText Typo="Typo.body2">@request.DateCreated.ToShortDateString()</MudText>
                                            </CardHeaderContent>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudText Typo="Typo.subtitle2"><strong>Comic:</strong></MudText>
                                            <MudText Typo="Typo.body2">@request.RequestedComicTitle</MudText>

                                            <MudText Typo="Typo.body2" Class="mt-3"><strong>Loan Duration:</strong>
                                                @request.LoanDurationDays days</MudText>

                                            @if (!string.IsNullOrEmpty(request.Message))
                                            {
                                                <MudText Typo="Typo.body2" Class="mt-2"><strong>Message:</strong> @request.Message
                                                </MudText>
                                            }
                                        </MudCardContent>
                                        <MudCardActions>
                                            @if (isIncoming)
                                            {
                                                <MudButton Variant="Variant.Text" Color="Color.Success" Size="Size.Small"
                                                    OnClick="@(() => AcceptLoanRequest(request.Id))" Disabled="@isProcessing">
                                                    Accept
                                                </MudButton>
                                                <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small"
                                                    OnClick="@(() => DeclineLoanRequest(request.Id))" Disabled="@isProcessing">
                                                    Decline
                                                </MudButton>
                                            }
                                            else
                                            {
                                                <MudButton Variant="Variant.Text" Color="Color.Default" Size="Size.Small"
                                                    OnClick="@(() => CancelLoanRequest(request.Id))" Disabled="@isProcessing">
                                                    Cancel Request
                                                </MudButton>
                                            }
                                            <MudButton Variant="Variant.Text" Color="Color.Default" Size="Size.Small"
                                                OnClick="@(() => SendMessage(isIncoming ? request.RequesterId : request.OwnerId))">
                                                Message
                                            </MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Active Loans">
                    @if (activeLoans == null || activeLoans.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-4">
                            No active loans at the moment.
                        </MudAlert>
                    }
                    else
                    {
                        <MudGrid Class="mt-4">
                            @foreach (var loan in activeLoans)
                            {
                                <MudItem xs="12">
                                    <MudCard>
                                        <MudCardHeader>
                                            <CardHeaderContent>
                                                <MudText Typo="Typo.h6">Loan with @loan.OtherUserName</MudText>
                                                <MudChip T="string" Color="@(loan.IsOverdue? Color.Error: Color.Info)"
                                                    Size="Size.Small">
                                                    @(loan.IsOverdue ? "Overdue" : loan.Status)
                                                </MudChip>
                                            </CardHeaderContent>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudGrid>
                                                @if (!string.IsNullOrEmpty(loan.BorrowedComicTitle))
                                                {
                                                    <MudItem xs="12" sm="6">
                                                        <MudText Typo="Typo.subtitle2"><strong>Comic you borrowed:</strong>
                                                        </MudText>
                                                        <MudText Typo="Typo.body2">@loan.BorrowedComicTitle
                                                            #@loan.BorrowedComicIssue</MudText>
                                                    </MudItem>
                                                }
                                                @if (!string.IsNullOrEmpty(loan.LentComicTitle))
                                                {
                                                    <MudItem xs="12" sm="6">
                                                        <MudText Typo="Typo.subtitle2"><strong>Comic you lent:</strong></MudText>
                                                        <MudText Typo="Typo.body2">@loan.LentComicTitle #@loan.LentComicIssue
                                                        </MudText>
                                                    </MudItem>
                                                }
                                            </MudGrid>

                                            <MudDivider Class="my-3" />

                                            <MudGrid>
                                                <MudItem xs="12" sm="4">
                                                    <MudText Typo="Typo.caption"><strong>Started:</strong></MudText>
                                                    <MudText Typo="Typo.body2">@loan.LoanStartDate.ToShortDateString()</MudText>
                                                </MudItem>
                                                <MudItem xs="12" sm="4">
                                                    <MudText Typo="Typo.caption"><strong>Due Date:</strong></MudText>
                                                    <MudText Typo="Typo.body2"
                                                        Color="@(loan.IsOverdue ? Color.Error : Color.Default)">
                                                        @loan.LoanEndDate.ToShortDateString()
                                                    </MudText>
                                                </MudItem>
                                                <MudItem xs="12" sm="4">
                                                    <MudText Typo="Typo.caption"><strong>Days Remaining:</strong></MudText>
                                                    <MudText Typo="Typo.body2"
                                                        Color="@(loan.RemainingDays < 0 ? Color.Error : (loan.RemainingDays <= 7 ? Color.Warning : Color.Default))">
                                                        @(loan.RemainingDays < 0 ? $"{Math.Abs(loan.RemainingDays)} days overdue" : $"{loan.RemainingDays} days")
                                                    </MudText>
                                                </MudItem>
                                            </MudGrid>

                                            <MudStepper Linear="false" Class="mt-4">
                                                <MudStep Title="Agreement" Completed="true">
                                                    Loan agreed on @loan.LoanStartDate.ToShortDateString()
                                                </MudStep>
                                                <MudStep Title="Meetup Arranged" Completed="@loan.MeetupArranged">
                                                    @if (loan.MeetupArranged)
                                                    {
                                                        <MudText>Meetup location confirmed</MudText>
                                                    }
                                                    else
                                                    {
                                                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                                            OnClick="@(() => ArrangeMeetup(loan.Id))">
                                                            Arrange Meetup</MudButton>
                                                    }
                                                </MudStep>
                                                <MudStep Title="Comic Exchanged" Completed="@loan.BothReceived">
                                                    @if (loan.YouReceived && loan.TheyReceived)
                                                    {
                                                        <MudText>Both parties confirmed exchange</MudText>
                                                    }
                                                    else if (!loan.YouReceived)
                                                    {
                                                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                                            OnClick="@(() => ConfirmReceived(loan.Id))">
                                                            Confirm Received</MudButton>
                                                    }
                                                    else
                                                    {
                                                        <MudText>Waiting for them to confirm...</MudText>
                                                    }
                                                </MudStep>
                                                <MudStep Title="Return Comic" Completed="@loan.ReturnMeetupArranged">
                                                    @if (loan.RemainingDays <= 7)
                                                    {
                                                        <MudAlert Severity="@(loan.IsOverdue? Severity.Error: Severity.Warning)"
                                                            Dense="true">
                                                            @(loan.IsOverdue ? "Please arrange return meetup as soon as possible!" : "Loan period ending soon. Arrange return meetup.")
                                                        </MudAlert>
                                                    }
                                                    @if (!loan.ReturnMeetupArranged)
                                                    {
                                                        <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                                            Class="mt-2" OnClick="@(() => ArrangeReturnMeetup(loan.Id))">
                                                            Arrange Return Meetup</MudButton>
                                                    }
                                                    else
                                                    {
                                                        <MudText Color="Color.Success">Return meetup arranged</MudText>
                                                    }
                                                </MudStep>
                                            </MudStepper>
                                        </MudCardContent>
                                        <MudCardActions Class="justify-space-between">
                                            <div>
                                                <MudButton Variant="Variant.Text" Color="Color.Default" Size="Size.Small"
                                                    OnClick="@(() => ViewLoanDetails(loan.Id))">
                                                    View Details
                                                </MudButton>
                                                <MudButton Variant="Variant.Text" Color="Color.Default" Size="Size.Small"
                                                    OnClick="@(() => SendMessage(loan.BorrowedComicTitle != string.Empty ? currentUserId : currentUserId))">
                                                    Message
                                                </MudButton>
                                            </div>
                                            @if (loan.ReturnMeetupArranged)
                                            {
                                                <div>
                                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                                                        StartIcon="@Icons.Material.Filled.CheckCircle"
                                                        OnClick="@(() => CompleteLoan(loan.Id))"
                                                        Disabled="@isProcessing">
                                                        Complete Return
                                                    </MudButton>
                                                </div>
                                            }
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>

                <MudTabPanel Text="Completed Loans">
                    @if (completedLoans == null || completedLoans.Count == 0)
                    {
                        <MudAlert Severity="Severity.Success" Class="mt-4">
                            No completed loans yet.
                        </MudAlert>
                    }
                    else
                    {
                        <MudGrid Class="mt-4">
                            @foreach (var loan in completedLoans)
                            {
                                <MudItem xs="12">
                                    <MudCard>
                                        <MudCardHeader>
                                            <CardHeaderContent>
                                                <MudText Typo="Typo.h6">Loan with @loan.OtherUserName</MudText>
                                                @if (loan.Rating > 0)
                                                {
                                                    <div class="d-flex align-center">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            <MudIcon Icon="@(i <= loan.Rating ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarOutline)" 
                                                                     Color="@(i <= loan.Rating ? Color.Warning : Color.Default)" 
                                                                     Size="Size.Small" />
                                                        }
                                                        <MudText Typo="Typo.caption" Class="ml-2">(@loan.Rating/5)</MudText>
                                                    </div>
                                                }
                                            </CardHeaderContent>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudGrid>
                                                <MudItem xs="12" sm="6">
                                                    <MudText Typo="Typo.body2"><strong>Comic borrowed:</strong>
                                                        @loan.BorrowedComicTitle</MudText>
                                                </MudItem>
                                                <MudItem xs="12" sm="6">
                                                    <MudText Typo="Typo.body2"><strong>Comic lent:</strong> @loan.LentComicTitle
                                                    </MudText>
                                                </MudItem>
                                            </MudGrid>
                                            <MudText Typo="Typo.body2" Class="mt-2"><strong>Duration:</strong>
                                                @loan.LoanStartDate.ToShortDateString() - @loan.LoanEndDate.ToShortDateString()
                                            </MudText>
                                            @if (!string.IsNullOrEmpty(loan.Review))
                                            {
                                                <MudText Typo="Typo.body2" Class="mt-2"><strong>Review:</strong> @loan.Review</MudText>
                                            }
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudTabPanel>
            </MudTabs>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int currentUserId = 0;
    private bool hasRendered = false;
    private bool isProcessing = false;
    private List<LoanRequestDto> pendingRequests = new();
    private List<ActiveLoanDto> activeLoans = new();
    private List<CompletedLoanDto> completedLoans = new();

    private class LoanRequestDto
    {
        public int Id { get; set; }
        public int RequesterId { get; set; }
        public string RequesterUsername { get; set; } = string.Empty;
        public int OwnerId { get; set; }
        public string OwnerUsername { get; set; } = string.Empty;
        public int RequestedComicId { get; set; }
        public string RequestedComicTitle { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public int RequestedLoanDurationDays { get; set; }
        public string? Message { get; set; }
        public DateTime DateCreated { get; set; }
        public DateTime? DateResponded { get; set; }
        public string? ResponseMessage { get; set; }

        public int LoanDurationDays => RequestedLoanDurationDays;
    }

    private class LoanDto
    {
        public int Id { get; set; }
        public int BorrowerId { get; set; }
        public string BorrowerUsername { get; set; } = string.Empty;
        public int LenderId { get; set; }
        public string LenderUsername { get; set; } = string.Empty;
        public int ComicId { get; set; }
        public string ComicTitle { get; set; } = string.Empty;
        public int ComicIssue { get; set; }
        public string Status { get; set; } = string.Empty;
        public DateTime LoanStartDate { get; set; }
        public DateTime LoanEndDate { get; set; }
        public DateTime? ActualReturnDate { get; set; }
        public DateTime? MeetupDateTime { get; set; }
        public DateTime? ReturnMeetupDateTime { get; set; }
        public bool BorrowerReceivedComic { get; set; }
        public bool LenderConfirmedReturn { get; set; }
    }

    private class ActiveLoanDto
    {
        public int Id { get; set; }
        public string OtherUserName { get; set; } = string.Empty;
        public string Status { get; set; } = "Active";
        public string BorrowedComicTitle { get; set; } = string.Empty;
        public int BorrowedComicIssue { get; set; }
        public string LentComicTitle { get; set; } = string.Empty;
        public int LentComicIssue { get; set; }
        public DateTime LoanStartDate { get; set; }
        public DateTime LoanEndDate { get; set; }
        public int RemainingDays { get; set; }
        public bool IsOverdue { get; set; }
        public bool MeetupArranged { get; set; }
        public bool YouReceived { get; set; }
        public bool TheyReceived { get; set; }
        public bool BothReceived => YouReceived && TheyReceived;
        public bool ReturnMeetupArranged { get; set; }
    }

    private class CompletedLoanDto
    {
        public int Id { get; set; }
        public string OtherUserName { get; set; } = string.Empty;
        public string BorrowedComicTitle { get; set; } = string.Empty;
        public string LentComicTitle { get; set; } = string.Empty;
        public DateTime LoanStartDate { get; set; }
        public DateTime LoanEndDate { get; set; }
        public int Rating { get; set; }
        public string Review { get; set; } = string.Empty;
    }

    private class LoanHistoryDto
    {
        public int Id { get; set; }
        public int BorrowerId { get; set; }
        public string BorrowerUsername { get; set; } = string.Empty;
        public int LenderId { get; set; }
        public string LenderUsername { get; set; } = string.Empty;
        public string ComicTitle { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public DateTime? LoanStartDate { get; set; }
        public DateTime LoanEndDate { get; set; }
        public string? Notes { get; set; }
        public int ReviewRating { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasRendered)
        {
            hasRendered = true;
            try
            {
                currentUserId = await LocalStorage.GetItemAsync<int>("currentUserId");
                if (currentUserId > 0)
                {
                    await LoadLoans();
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing Loans page");
            }
        }
    }

    private async Task LoadLoans()
    {
        try
        {
            var requestsResponse = await Http.GetAsync($"api/loans/requests/user/{currentUserId}");
            if (requestsResponse.IsSuccessStatusCode)
            {
                var allRequests = await requestsResponse.Content.ReadFromJsonAsync<List<LoanRequestDto>>() ?? new();
                pendingRequests = allRequests.Where(r => r.Status == "Pending").ToList();
                Logger.LogInformation($"Loaded {pendingRequests.Count} pending loan requests");
            }
            else
            {
                Logger.LogWarning($"Failed to load loan requests: {requestsResponse.StatusCode}");
            }

            var loansResponse = await Http.GetAsync($"api/loans/user/{currentUserId}");
            if (loansResponse.IsSuccessStatusCode)
            {
                var allLoans = await loansResponse.Content.ReadFromJsonAsync<List<LoanDto>>() ?? new();
                
                activeLoans = allLoans.Where(l => l.Status == "Active").Select(l => new ActiveLoanDto
                {
                    Id = l.Id,
                    OtherUserName = l.BorrowerId == currentUserId ? l.LenderUsername : l.BorrowerUsername,
                    Status = l.Status,
                    BorrowedComicTitle = l.BorrowerId == currentUserId ? l.ComicTitle : "",
                    BorrowedComicIssue = l.BorrowerId == currentUserId ? l.ComicIssue : 0,
                    LentComicTitle = l.LenderId == currentUserId ? l.ComicTitle : "",
                    LentComicIssue = l.LenderId == currentUserId ? l.ComicIssue : 0,
                    LoanStartDate = l.LoanStartDate,
                    LoanEndDate = l.LoanEndDate,
                    RemainingDays = (int)(l.LoanEndDate - DateTime.UtcNow).TotalDays,
                    IsOverdue = l.LoanEndDate < DateTime.UtcNow,
                    MeetupArranged = l.MeetupDateTime.HasValue,
                    YouReceived = l.BorrowerId == currentUserId ? l.BorrowerReceivedComic : l.LenderConfirmedReturn,
                    TheyReceived = l.BorrowerId == currentUserId ? l.LenderConfirmedReturn : l.BorrowerReceivedComic,
                    ReturnMeetupArranged = l.ReturnMeetupDateTime.HasValue
                }).ToList();
                
                Logger.LogInformation($"Loaded {activeLoans.Count} active loans");
            }
            else
            {
                Logger.LogWarning($"Failed to load active loans: {loansResponse.StatusCode}");
                activeLoans = new();
            }

            var historyResponse = await Http.GetAsync($"api/loans/history/user/{currentUserId}");
            if (historyResponse.IsSuccessStatusCode)
            {
                var historyLoans = await historyResponse.Content.ReadFromJsonAsync<List<LoanHistoryDto>>() ?? new();
                
                completedLoans = historyLoans.Where(l => l.Status == "Returned").Select(l => new CompletedLoanDto
                {
                    Id = l.Id,
                    OtherUserName = l.BorrowerId == currentUserId ? l.LenderUsername : l.BorrowerUsername,
                    BorrowedComicTitle = l.BorrowerId == currentUserId ? l.ComicTitle : "",
                    LentComicTitle = l.LenderId == currentUserId ? l.ComicTitle : "",
                    LoanStartDate = l.LoanStartDate ?? DateTime.MinValue,
                    LoanEndDate = l.LoanEndDate,
                    Rating = l.ReviewRating,
                    Review = l.Notes ?? ""
                }).ToList();
                
                Logger.LogInformation($"Loaded {completedLoans.Count} completed loans");
            }
            else
            {
                Logger.LogWarning($"Failed to load loan history: {historyResponse.StatusCode}");
                completedLoans = new();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading loans");
            Snackbar.Add("Failed to load loans. Please try again.", Severity.Error);
        }
    }

    private async Task ArrangeMeetup(int loanId)
    {
        var loan = activeLoans.FirstOrDefault(l => l.Id == loanId);
        if (loan == null) return;

        var parameters = new DialogParameters
        {
            { "LoanId", loanId },
            { "OtherUserName", loan.OtherUserName },
            { "ComicTitle", !string.IsNullOrEmpty(loan.BorrowedComicTitle) ? loan.BorrowedComicTitle : loan.LentComicTitle },
            { "IsReturnMeetup", false },
            { "Title", "Arrange Initial Meetup" }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<MeetupDialog>("Arrange Meetup", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadLoans();
            StateHasChanged();
        }
    }

    private async Task ConfirmReceived(int loanId)
    {
        var loan = activeLoans.FirstOrDefault(l => l.Id == loanId);
        if (loan == null) return;

        var parameters = new DialogParameters
        {
            { "ContentText", "Confirm that you have received the comic at the meetup?" },
            { "ButtonText", "Confirm Received" },
            { "Color", Color.Success }
        };

        var confirmDialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Receipt", parameters);
        var confirmResult = await confirmDialog.Result;

        if (confirmResult.Canceled)
        {
            return;
        }

        try
        {
            var isBorrower = !string.IsNullOrEmpty(loan.BorrowedComicTitle);
            var dto = new { IsBorrower = isBorrower };
            
            var response = await Http.PostAsJsonAsync($"api/loans/{loanId}/confirm-received", dto);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Receipt confirmed successfully!", Severity.Success);
                await LoadLoans();
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to confirm receipt: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error confirming receipt for loan {loanId}");
            Snackbar.Add("An error occurred while confirming receipt.", Severity.Error);
        }
    }

    private async Task ArrangeReturnMeetup(int loanId)
    {
        var loan = activeLoans.FirstOrDefault(l => l.Id == loanId);
        if (loan == null) return;

        var parameters = new DialogParameters
        {
            { "LoanId", loanId },
            { "OtherUserName", loan.OtherUserName },
            { "ComicTitle", !string.IsNullOrEmpty(loan.BorrowedComicTitle) ? loan.BorrowedComicTitle : loan.LentComicTitle },
            { "IsReturnMeetup", true },
            { "Title", "Arrange Return Meetup" }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<MeetupDialog>("Arrange Return Meetup", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadLoans();
            StateHasChanged();
        }
    }

    private async Task AcceptLoanRequest(int requestId)
    {
        isProcessing = true;
        try
        {
            var response = await Http.PostAsync($"api/loans/requests/{requestId}/accept", null);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Loan request accepted successfully!", Severity.Success);
                await LoadLoans();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to accept loan request: {error}", Severity.Error);
                Logger.LogWarning($"Failed to accept loan request {requestId}: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error accepting loan request {requestId}");
            Snackbar.Add("An error occurred while accepting the loan request.", Severity.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task DeclineLoanRequest(int requestId)
    {
        isProcessing = true;
        try
        {
            var response = await Http.PostAsJsonAsync($"api/loans/requests/{requestId}/decline", 
                new { Message = "Declined" });
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Loan request declined.", Severity.Info);
                await LoadLoans();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to decline loan request: {error}", Severity.Error);
                Logger.LogWarning($"Failed to decline loan request {requestId}: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error declining loan request {requestId}");
            Snackbar.Add("An error occurred while declining the loan request.", Severity.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task CancelLoanRequest(int requestId)
    {
        isProcessing = true;
        try
        {
            var response = await Http.PostAsJsonAsync($"api/loans/requests/{requestId}/decline", 
                new { Message = "Cancelled by requester" });
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Loan request cancelled.", Severity.Info);
                await LoadLoans();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to cancel loan request: {error}", Severity.Error);
                Logger.LogWarning($"Failed to cancel loan request {requestId}: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error cancelling loan request {requestId}");
            Snackbar.Add("An error occurred while cancelling the loan request.", Severity.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void SendMessage(int userId)
    {
        try
        {
            Snackbar.Add("Message feature - Navigate to /messages", Severity.Info);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error navigating to messages for user {userId}");
            Snackbar.Add("Failed to open messaging.", Severity.Error);
        }
    }

    private async Task CompleteLoan(int loanId)
    {
        var loan = activeLoans.FirstOrDefault(l => l.Id == loanId);
        if (loan == null) return;

        string otherUserName = loan.OtherUserName;
        string comicTitle = !string.IsNullOrEmpty(loan.BorrowedComicTitle) 
            ? loan.BorrowedComicTitle 
            : loan.LentComicTitle;

        var parameters = new DialogParameters
        {
            { "ContentText", "Are you sure the comic has been returned at the meetup?" },
            { "ButtonText", "Yes, Comic Returned" },
            { "Color", Color.Success }
        };

        var confirmDialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Return", parameters);
        var confirmResult = await confirmDialog.Result;

        if (confirmResult.Canceled)
        {
            return;
        }

        isProcessing = true;
        try
        {
            var response = await Http.PostAsync($"api/loans/{loanId}/return", null);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Loan marked as completed!", Severity.Success);
                
                // Show review dialog BEFORE reloading
                await ShowReviewDialog(loanId, otherUserName, comicTitle);
                
                // Reload after completion
                await LoadLoans();
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to complete loan: {error}", Severity.Error);
                Logger.LogWarning($"Failed to complete loan {loanId}: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, $"Error completing loan {loanId}");
            Snackbar.Add("An error occurred while completing the loan.", Severity.Error);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ShowReviewDialog(int loanId, string otherUserName, string comicTitle)
    {
        var parameters = new DialogParameters
        {
            { "LoanId", loanId },
            { "ReviewerId", currentUserId },
            { "OtherUserName", otherUserName },
            { "ComicTitle", comicTitle }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true,  // Allow user to cancel
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true
        };

        var reviewDialog = await DialogService.ShowAsync<ReviewDialog>("Leave Review", parameters, options);
        var reviewResult = await reviewDialog.Result;

        if (reviewResult != null && !reviewResult.Canceled)
        {
            Snackbar.Add("Thank you for your review!", Severity.Success);
        }
        else
        {
            // User cancelled - inform them they can review later
            Snackbar.Add("You can add a review later from your loan history.", Severity.Info);
        }
    }

    private void ViewLoanDetails(int loanId)
    {
        Snackbar.Add($"Viewing loan details for loan #{loanId}", Severity.Info);
    }
}
