@page "/edit-comic/{ComicId:int}"
@using MudBlazor
@using Blazored.LocalStorage
@using System.Net.Http.Json
@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject ILogger<EditComic> Logger
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Edit Comic</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-8">
    <MudPaper Elevation="2" Class="pa-6">
        <MudText Typo="Typo.h4" Class="mb-6">Edit Comic</MudText>

        @if (isLoading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
            <MudText Typo="Typo.body2" Align="Align.Center">Loading comic details...</MudText>
        }
        else if (comic == null)
        {
            <MudAlert Severity="Severity.Error">Comic not found.</MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4"
                OnClick="@(() => NavigationManager.NavigateTo("/my-collection"))">
                Back to Collection
            </MudButton>
        }
        else
        {
            <EditForm Model="@comic" OnValidSubmit="@HandleSubmit">
                <DataAnnotationsValidator />
                <MudGrid>
                    <MudItem xs="12" sm="8">
                        <MudTextField @bind-Value="comic.Title" Label="Comic Title" Variant="Variant.Outlined" FullWidth
                            Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="comic.IssueNumber" Label="Issue #" Variant="Variant.Outlined"
                            FullWidth Required="true" Min="1" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="comic.Publisher" Label="Publisher" Variant="Variant.Outlined" FullWidth
                            Required="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="comic.Era" Label="Era" Variant="Variant.Outlined" Required="true">
                            <MudSelectItem Value="@("Golden Age")">Golden Age (1938-1956)</MudSelectItem>
                            <MudSelectItem Value="@("Silver Age")">Silver Age (1956-1970)</MudSelectItem>
                            <MudSelectItem Value="@("Bronze Age")">Bronze Age (1970-1985)</MudSelectItem>
                            <MudSelectItem Value="@("Modern Age")">Modern Age (1985-2011)</MudSelectItem>
                            <MudSelectItem Value="@("Contemporary")">Contemporary (2011-Present)</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="comic.Characters" Label="Main Characters" Variant="Variant.Outlined"
                            FullWidth Placeholder="e.g., Spider-Man, Green Goblin" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Condition Information</strong></MudText>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="comic.ConditionGrade" Label="Condition" Variant="Variant.Outlined"
                            Required="true">
                            <MudSelectItem Value="@("Like New")">Like New - Pristine, barely read</MudSelectItem>
                            <MudSelectItem Value="@("Very Good")">Very Good - Minor wear, well cared for</MudSelectItem>
                            <MudSelectItem Value="@("Good")">Good - Normal wear, fully readable</MudSelectItem>
                            <MudSelectItem Value="@("Acceptable")">Acceptable - Visible wear but complete</MudSelectItem>
                            <MudSelectItem Value="@("Well-Loved")">Well-Loved - Heavy wear but readable</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudCheckBox T="bool" @bind-Value="comic.IsAvailable" Label="Available for Loan"
                            Color="Color.Success" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="comic.ConditionDescription" Label="Condition Notes (Optional)"
                            Variant="Variant.Outlined" FullWidth Multiline="true" Lines="2"
                            Placeholder="e.g., Small crease on back cover" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="comic.CoverImageUrl" Label="Cover Image URL (Optional)"
                            Variant="Variant.Outlined" FullWidth HelperText="Leave blank to use default cover image" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="comic.OwnerNotes" Label="Notes for Borrowers (Optional)"
                            Variant="Variant.Outlined" FullWidth Multiline="true" Lines="2"
                            Placeholder="e.g., Part of a great story arc!" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="comic.Description" Label="Description"
                            Variant="Variant.Outlined" FullWidth Multiline="true" Lines="4"
                            Placeholder="e.g., A brief description of the comic" />
                    </MudItem>

                    <MudItem xs="12" Class="d-flex gap-2 mt-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit"
                            Loading="@isSaving">
                            <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-1" />
                            Save Changes
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Default"
                            OnClick="@(() => NavigationManager.NavigateTo("/my-collection"))">
                            Cancel
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>



            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public int ComicId { get; set; }

    private ComicEditDto? comic;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private int currentUserId = 0;

    private class ComicEditDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public int IssueNumber { get; set; }
        public string Publisher { get; set; } = string.Empty;
        public string ConditionGrade { get; set; } = string.Empty;
        public string ConditionDescription { get; set; } = string.Empty;
        public string Era { get; set; } = string.Empty;
        public string? CoverImageUrl { get; set; }
        public string Characters { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string OwnerNotes { get; set; } = string.Empty;
        public bool IsAvailable { get; set; }
        public int OwnerId { get; set; }
    }

    private bool hasInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasInitialized)
        {
            hasInitialized = true;
            try
            {
                currentUserId = await LocalStorage.GetItemAsync<int>("currentUserId");
                if (currentUserId <= 0)
                {
                    errorMessage = "You must be logged in to edit comics.";
                    isLoading = false;
                    StateHasChanged();
                    return;
                }

                await LoadComic();
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing edit comic page");
                errorMessage = "An error occurred while loading the comic.";
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task LoadComic()
    {
        try
        {
            isLoading = true;
            var response = await Http.GetAsync($"api/comics/{ComicId}");

            if (response.IsSuccessStatusCode)
            {
                comic = await response.Content.ReadFromJsonAsync<ComicEditDto>();

                if (comic?.OwnerId != currentUserId)
                {
                    errorMessage = "You can only edit your own comics.";
                    comic = null;
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                errorMessage = "Comic not found.";
            }
            else
            {
                errorMessage = "Failed to load comic details.";
                Logger.LogWarning($"Failed to load comic: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading comic");
            errorMessage = "An error occurred while loading the comic.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (comic == null)
            return;

        try
        {
            isSaving = true;
            errorMessage = string.Empty;

            var response = await Http.PutAsJsonAsync($"api/comics/{ComicId}", comic);

            if (response.IsSuccessStatusCode)
            {
                Logger.LogInformation($"Comic {ComicId} updated successfully");
                NavigationManager.NavigateTo("/my-collection");
            }
            else
            {
                Logger.LogWarning($"Failed to update comic: {response.StatusCode}");
                errorMessage = "Failed to save changes. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating comic");
            errorMessage = "An error occurred while saving the comic.";
        }
        finally
        {
            isSaving = false;
        }
    }
}