@page "/"
@using MudBlazor
@using A6_ComicBooksLoanApp.Services
@inject AdminApiService AdminApiService

<PageTitle>Comic Books Loan Exchange</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="3" Class="pa-6"
                Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <MudContainer>
                    <MudText Typo="Typo.h3" GutterBottom="true" Class="font-weight-bold">
                        📚 Comic Books Loan Exchange
                    </MudText>
                    <MudText Typo="Typo.subtitle1">
                        Borrow and lend comic books within a trusted community. Share your passion with fellow
                        collectors.
                    </MudText>
                    <MudText Typo="Typo.body2" Class="mt-4">
                        <strong>How it works:</strong> Request to borrow comics from other collectors, lend your comics
                        to those who appreciate them, and build connections through shared collecting interests.
                    </MudText>
                </MudContainer>
            </MudPaper>
        </MudItem>

        <!-- Platform News & Updates Section -->
        <MudItem xs="12" Class="mt-6">
            <MudText Typo="Typo.h5" GutterBottom="true" Class="mb-4">
                📰 Platform News & Updates
            </MudText>
            @if (isLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            }
            else if (announcements != null && announcements.Any())
            {
                <MudGrid>
                    @foreach (var announcement in announcements)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudCard Elevation="2" Style="height: 100%;">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">
                                            @GetAnnouncementIcon(announcement.Type) @announcement.Title
                                        </MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudChip T="string" Size="Size.Small" Color="@GetAnnouncementColor(announcement.Type)"
                                            Variant="Variant.Text">
                                            @announcement.Type
                                        </MudChip>
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudText Typo="Typo.body2">
                                        @announcement.Content
                                    </MudText>
                                    <MudText Typo="Typo.caption" Class="mt-2" Style="color: #999;">
                                        Posted @FormatAnnouncementDate(announcement.CreatedAt) by
                                        @announcement.CreatedByUsername
                                    </MudText>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info">
                    No announcements at this time. Check back later for platform updates!
                </MudAlert>
            }
        </MudItem>
    </MudGrid>

    @* <MudGrid Class="mt-8">
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h5" GutterBottom="true">Active Loan Categories</MudText>
                <MudText Typo="Typo.body2" GutterBottom="true">
                    Popular collecting interests in our lending community
                </MudText>
                <MudGrid Class="mt-4">
                    <MudItem xs="12" sm="6" md="4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth
                            StartIcon="@Icons.Material.Filled.LocalFireDepartment" Href="/comics?era=Bronze Age">
                            Bronze Age Marvel
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" FullWidth
                            StartIcon="@Icons.Material.Filled.LocalFireDepartment" Href="/comics?era=Silver Age">
                            Silver Age DC
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth
                            StartIcon="@Icons.Material.Filled.LocalFireDepartment" Href="/comics?filter=keyissues">
                            Key Issues
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-8">
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-6">
                <MudText Typo="Typo.h5" GutterBottom="true">How Comic Lending Works</MudText>
                <MudStepper>
                    <MudStep Title="Create Profile" Description="Join the community and showcase your collection">
                        <MudText Typo="Typo.body2">
                            Register and set up your profile with your collecting focus, reading interests, and
                            preferred loan terms.
                            Add comics from your collection that you're willing to lend.
                        </MudText>
                    </MudStep>
                    <MudStep Title="Browse & Request" Description="Find comics to borrow and send loan requests">
                        <MudText Typo="Typo.body2">
                            Search available comics by era, character, publisher, or condition. When you find something
                            interesting,
                            send a loan request to the owner specifying your desired loan duration.
                        </MudText>
                    </MudStep>
                    <MudStep Title="Approve Requests" Description="Review and approve loan requests for your comics">
                        <MudText Typo="Typo.body2">
                            As a comic owner, review incoming loan requests. Accept requests from trusted members and
                            arrange meetup details for comic handoff.
                        </MudText>
                    </MudStep>
                    <MudStep Title="Loan Period" Description="Enjoy reading while respecting the agreed return date">
                        <MudText Typo="Typo.body2">
                            Both parties track active loans with clear return dates. Communicate through the messaging
                            system
                            to coordinate returns or extend loans if needed.
                        </MudText>
                    </MudStep>
                    <MudStep Title="Return & Review" Description="Complete the loan and share feedback">
                        <MudText Typo="Typo.body2">
                            Return comics on time in the same condition. Leave reviews to build trust in the community
                            and help others know who are reliable borrowers and lenders.
                        </MudText>
                    </MudStep>
                </MudStepper>
            </MudPaper>
        </MudItem>
    </MudGrid> *@
</MudContainer>
@code {
    private List<AnnouncementDto> announcements = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnnouncements();
    }

    private async Task LoadAnnouncements()
    {
        isLoading = true;
        try
        {
            announcements = await AdminApiService.GetActiveAnnouncementsAsync();
        }
        catch (Exception)
        {
            announcements = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetAnnouncementIcon(string type)
    {
        return type switch
        {
            "Feature" => "",
            "Maintenance" => "",
            "Event" => "",
            "Update" => "",
            _ => ""
        };
    }

    private Color GetAnnouncementColor(string type)
    {
        return type switch
        {
            "Feature" => Color.Primary,
            "Maintenance" => Color.Warning,
            "Event" => Color.Success,
            "Update" => Color.Info,
            _ => Color.Default
        };
    }

    private string FormatAnnouncementDate(DateTime date)
    {
        var timeSpan = DateTime.UtcNow - date;

        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} minutes ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} hours ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} days ago";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)} weeks ago";

        return date.ToString("MMM dd, yyyy");
    }
}